# E2E Test Infrastructure Validation - MANDATORY

**Context**: Prevents test failures due to missing scripts, stopped servers, or misconfigured environment.

**Rationale**: Tests should fail only when code is broken, not when infrastructure is misconfigured.

---

## Golden Rule

```
‚úÖ VALIDATE infrastructure BEFORE running tests
üö´ NEVER assume scripts/servers exist
‚ö†Ô∏è FAIL FAST with clear error messages
```

---

## Pre-Test Checklist

Before running ANY E2E tests, validate:

### Backend Scripts
- [ ] `npm run db:reset:force` exists
- [ ] `npm run start:dev` exists
- [ ] `npm run prisma:seed` exists

### Frontend Scripts
- [ ] `npm run dev` exists
- [ ] `npx playwright test` works

### Environment
- [ ] Backend running on localhost:3001
- [ ] Frontend running on localhost:3000
- [ ] Database accessible
- [ ] Test account seeded

---

## Validation Script

Create `scripts/validate-test-env.sh`:

```bash
#!/bin/bash
# Validates E2E test environment before running tests

set -e

echo "üîç Validating E2E Test Environment..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check backend scripts
echo "1Ô∏è‚É£ Checking backend scripts..."
cd apps/backend

if ! npm run --silent 2>&1 | grep -q "db:reset:force"; then
  echo -e "${RED}‚ùå Missing script: db:reset:force${NC}"
  echo "   Add to apps/backend/package.json:"
  echo '   "db:reset:force": "prisma migrate reset --force --skip-seed && ts-node prisma/seed.ts"'
  exit 1
fi
echo -e "${GREEN}‚úÖ db:reset:force exists${NC}"

if ! npm run --silent 2>&1 | grep -q "start:dev"; then
  echo -e "${RED}‚ùå Missing script: start:dev${NC}"
  exit 1
fi
echo -e "${GREEN}‚úÖ start:dev exists${NC}"

cd ../..

# Check backend running
echo ""
echo "2Ô∏è‚É£ Checking backend server..."
if curl -f -s http://localhost:3001/health > /dev/null 2>&1; then
  echo -e "${GREEN}‚úÖ Backend running on localhost:3001${NC}"
else
  echo -e "${RED}‚ùå Backend not running${NC}"
  echo "   Start with: cd apps/backend && npm run start:dev"
  exit 1
fi

# Check frontend running
echo ""
echo "3Ô∏è‚É£ Checking frontend server..."
if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
  echo -e "${GREEN}‚úÖ Frontend running on localhost:3000${NC}"
else
  echo -e "${RED}‚ùå Frontend not running${NC}"
  echo "   Start with: cd apps/frontend && npm run dev"
  exit 1
fi

# Check database
echo ""
echo "4Ô∏è‚É£ Checking database..."
cd apps/backend
if npx prisma db execute --stdin < /dev/null 2>&1 | grep -q "Error"; then
  echo -e "${RED}‚ùå Database not accessible${NC}"
  exit 1
else
  echo -e "${GREEN}‚úÖ Database accessible${NC}"
fi
cd ../..

# Check test account
echo ""
echo "5Ô∏è‚É£ Checking test account..."
TEST_ACCOUNT=$(curl -s http://localhost:3001/accounts | grep -o '"name":"Test Account"')
if [ -z "$TEST_ACCOUNT" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è Test Account not found - running seed...${NC}"
  cd apps/backend
  npm run prisma:seed
  cd ../..
  echo -e "${GREEN}‚úÖ Test Account created${NC}"
else
  echo -e "${GREEN}‚úÖ Test Account exists${NC}"
fi

echo ""
echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${GREEN}‚úÖ Environment validated - ready for tests${NC}"
echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
```

**Usage**:
```bash
chmod +x scripts/validate-test-env.sh
./scripts/validate-test-env.sh && npm run test:e2e
```

---

## Test File Template

Add to **every** E2E test file:

```typescript
import { test, expect } from '@playwright/test';
import { execSync } from 'child_process';

const BACKEND_URL = 'http://localhost:3001';
const FRONTEND_URL = 'http://localhost:3000';

/**
 * Validate environment before running tests
 */
test.beforeAll(async () => {
  console.log('=== VALIDATING TEST ENVIRONMENT ===');
  
  // 1. Check backend is running
  try {
    const response = await fetch(`${BACKEND_URL}/health`);
    if (!response.ok) {
      throw new Error(`Backend unhealthy: ${response.status}`);
    }
    console.log('‚úì Backend is running');
  } catch (error) {
    throw new Error(
      '‚ùå Backend not running!\n' +
      'Start with: cd apps/backend && npm run start:dev'
    );
  }
  
  // 2. Check frontend is running
  try {
    const response = await fetch(FRONTEND_URL);
    if (!response.ok) {
      throw new Error(`Frontend not responding: ${response.status}`);
    }
    console.log('‚úì Frontend is running');
  } catch (error) {
    throw new Error(
      '‚ùå Frontend not running!\n' +
      'Start with: cd apps/frontend && npm run dev'
    );
  }
  
  // 3. Validate required npm scripts exist
  try {
    const scripts = execSync('npm run --json', {
      cwd: 'apps/backend',
      encoding: 'utf-8'
    });
    
    if (!scripts.includes('db:reset:force')) {
      throw new Error(
        '‚ùå Missing script: db:reset:force\n' +
        'Add to apps/backend/package.json:\n' +
        '"db:reset:force": "prisma migrate reset --force --skip-seed && ts-node prisma/seed.ts"'
      );
    }
    console.log('‚úì Required scripts exist');
  } catch (error: any) {
    if (error.message.includes('Missing script')) {
      throw error;
    }
  }
  
  console.log('‚úÖ Environment validation complete');
});
```

---

## Package.json Integration

Add to `apps/frontend/package.json`:

```json
{
  "scripts": {
    "test:e2e": "../../scripts/validate-test-env.sh && npx playwright test",
    "test:e2e:force": "npx playwright test"
  }
}
```

This ensures validation runs automatically, but allows bypass in emergencies.

---

## Error Messages

### Good Error Messages ‚úÖ

```
‚ùå Backend not running!

Start backend with:
  cd apps/backend
  npm run start:dev

Then re-run tests.
```

### Bad Error Messages ‚ùå

```
Error: connect ECONNREFUSED
```

---

## Benefits

1. **Fail Fast**: Catch environment issues in < 5 seconds
2. **Clear Guidance**: Developers know exactly what to fix
3. **Consistent**: Same validation for all developers
4. **Documented**: Validation script serves as documentation
5. **Automated**: No manual checklist needed

---

## Related Rules

- [API-First Test Design](mdc:.cursor/rules/api-first-testing.mdc)
- [Test Data Management](mdc:.cursor/rules/test-data-strategy.mdc)

---

**Last Updated**: 2026-02-04  
**Origin**: [Retrospective - Test Execution Issues](mdc:docs/retrospectives/RETRO_TEST_EXECUTION_2026_02_04.md)
